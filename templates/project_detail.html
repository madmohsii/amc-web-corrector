% extends "base.html" %}

{% block title %}{{ project.name }} - AMC Web Corrector{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>{{ project.name }}</h1>
            <p>Projet créé le {{ project.created[:10] }}</p>
        </div>
        <a href="{{ url_for('list_projects') }}" class="btn btn-secondary">Retour</a>
    </div>
</div>

<!-- Zone d'upload -->
<div class="card">
    <h2>📤 Upload des copies</h2>
    <div id="enhancedUploader">
        <!-- L'interface sera créée par JavaScript -->
    </div>
</div>

<!-- Fichiers uploadés -->
<!-- Cette section est maintenant gérée par enhanced-upload.js -->

<!-- Actions de traitement -->
<div class="card">
    <h2>⚙️ Configuration et Traitement</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <a href="{{ url_for('configure_project', project_id=project_id) }}" class="btn btn-secondary">
            📝 Configurer le QCM
        </a>
        <button onclick="processProject()" class="btn" {% if not uploaded_files %}disabled{% endif %}>
            🚀 Lancer le traitement
        </button>
        <button onclick="viewResults()" class="btn btn-secondary">
            📊 Voir les résultats
        </button>
        <button onclick="exportResults()" class="btn btn-secondary">
            📥 Exporter les notes
        </button>
    </div>
    
    {% if not uploaded_files %}
    <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
        ⚠️ Vous devez d'abord uploader des copies avant de lancer le traitement
    </div>
    {% endif %}
    
    <!-- Informations sur le QCM configuré -->
    <div id="qcmInfo" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 1rem; display: none;">
        <h4>📋 Configuration actuelle :</h4>
        <div id="qcmInfoContent">
            <!-- Les infos seront ajoutées par JavaScript -->
        </div>
    </div>
</div>

<!-- Zone de résultats -->
<div id="resultsArea" class="card" style="display: none;">
    <h2>📈 Résultats du traitement</h2>
    <div id="resultsContent">
        <!-- Les résultats seront affichés ici -->
    </div>
</div>

<!-- Loading -->
<div class="loading">
    <div class="spinner"></div>
    <p>Traitement en cours...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
const projectId = '{{ project_id }}';

// Configuration du drag & drop
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    setupDragDrop(uploadArea);
});

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    for (let file of files) {
        uploadFile(file);
    }
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressDiv.style.display = 'block';
    progressText.textContent = `Upload de ${file.name}...`;
    
    fetch(`/upload/${projectId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressText.textContent = 'Upload terminé!';
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
            progressDiv.style.display = 'none';
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'upload: ' + error);
        progressDiv.style.display = 'none';
    });
}

function removeFile(filename) {
    if (confirm(`Supprimer le fichier ${filename} ?`)) {
        // Ici vous pourriez ajouter une route de suppression de fichier
        alert('Fonctionnalité de suppression à implémenter');
    }
}

function processProject() {
    if (!confirm('Lancer le traitement AMC ? Cela peut prendre plusieurs minutes.')) {
        return;
    }
    
    showLoading();
    
    fetch(`/process/${projectId}`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            alert('Traitement terminé avec succès!');
            showResults(data.results);
        } else {
            alert('Erreur lors du traitement: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        alert('Erreur: ' + error);
    });
}

function showResults(results) {
    const resultsArea = document.getElementById('resultsArea');
    const resultsContent = document.getElementById('resultsContent');
    
    let html = '<h3>Résultats du traitement:</h3>';
    
    results.forEach((result, index) => {
        html += `
            <div style="margin-bottom: 1rem; padding: 1rem; background: ${result.success ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                <strong>Étape ${index + 1}:</strong> ${result.success ? '✅ Succès' : '❌ Erreur'}
                <details style="margin-top: 0.5rem;">
                    <summary>Détails</summary>
                    <pre style="margin-top: 0.5rem; font-size: 0.9rem;">${result.stdout || result.stderr || result.error}</pre>
                </details>
            </div>
        `;
    });
    
    resultsContent.innerHTML = html;
    resultsArea.style.display = 'block';
}

function viewResults() {
    window.open(`/results/${projectId}`, '_blank');
}

function exportResults() {
    // Ici vous pourriez ajouter l'export des résultats
    alert('Fonctionnalité d\'export à implémenter');
}
</script>
{% endblock %}
