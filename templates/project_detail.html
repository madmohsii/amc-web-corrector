<!-- ============================================ -->
<!-- templates/project_detail.html -->
{% extends "base.html" %}

{% block title %}{{ project.name }} - AMC Web Corrector{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>{{ project.name }}</h1>
            <p>Projet créé le {{ project.created[:10] }}</p>
        </div>
        <a href="{{ url_for('list_projects') }}" class="btn btn-secondary">Retour</a>
    </div>
</div>

<!-- Zone d'upload -->
<div class="card">
    <h2>📤 Upload des copies</h2>
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
        <h3>Glissez vos fichiers ici ou cliquez pour sélectionner</h3>
        <p>Formats acceptés: PDF, PNG, JPG, JPEG</p>
        <input type="file" id="fileInput" style="display: none;" multiple 
               accept=".pdf,.png,.jpg,.jpeg" onchange="handleFileSelect(this.files)">
    </div>
    
    <!-- Progress bar -->
    <div id="uploadProgress" style="display: none; margin-top: 1rem;">
        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
            <div id="progressBar" style="height: 20px; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
        </div>
        <p id="progressText" style="text-align: center; margin-top: 0.5rem;">Upload en cours...</p>
    </div>
</div>

<!-- Fichiers uploadés -->
<div class="card">
    <h2>📋 Fichiers uploadés</h2>
    {% if uploaded_files %}
        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
            {% for file in uploaded_files %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
                <div>
                    <strong>{{ file }}</strong>
                    <div style="color: #666; font-size: 0.9rem;">
                        Uploadé récemment
                    </div>
                </div>
                <button onclick="removeFile('{{ file }}')" class="btn btn-danger" style="padding: 8px 16px;">
                    Supprimer
                </button>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 2rem;">
            Aucun fichier uploadé pour le moment
        </p>
    {% endif %}
</div>

<!-- Actions de traitement -->
<div class="card">
    <h2>⚙️ Traitement AMC</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="processProject()" class="btn" {% if not uploaded_files %}disabled{% endif %}>
            🚀 Lancer le traitement
        </button>
        <button onclick="viewResults()" class="btn btn-secondary">
            📊 Voir les résultats
        </button>
        <button onclick="exportResults()" class="btn btn-secondary">
            📥 Exporter les notes
        </button>
    </div>
    
    {% if not uploaded_files %}
    <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
        ⚠️ Vous devez d'abord uploader des copies avant de lancer le traitement
    </div>
    {% endif %}
</div>

<!-- Zone de résultats -->
<div id="resultsArea" class="card" style="display: none;">
    <h2>📈 Résultats du traitement</h2>
    <div id="resultsContent">
        <!-- Les résultats seront affichés ici -->
    </div>
</div>

<!-- Loading -->
<div class="loading">
    <div class="spinner"></div>
    <p>Traitement en cours...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
const projectId = '{{ project_id }}';

// Configuration du drag & drop
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    setupDragDrop(uploadArea);
});

function handleFileSelect(files) {
    if (files.length === 0) return;
    
    for (let file of files) {
        uploadFile(file);
    }
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressDiv.style.display = 'block';
    progressText.textContent = `Upload de ${file.name}...`;
    
    fetch(`/upload/${projectId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressText.textContent = 'Upload terminé!';
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
            progressDiv.style.display = 'none';
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'upload: ' + error);
        progressDiv.style.display = 'none';
    });
}

function removeFile(filename) {
    if (confirm(`Supprimer le fichier ${filename} ?`)) {
        alert('Fonctionnalité de suppression à implémenter');
    }
}

function processProject() {
    if (!confirm('Lancer le traitement AMC ? Cela peut prendre plusieurs minutes.')) {
        return;
    }
    
    showLoading();
    
    fetch(`/process/${projectId}`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            alert('Traitement terminé avec succès!');
            showResults(data.results);
        } else {
            alert('Erreur lors du traitement: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        alert('Erreur: ' + error);
    });
}

function showResults(results) {
    const resultsArea = document.getElementById('resultsArea');
    const resultsContent = document.getElementById('resultsContent');
    
    let html = '<h3>Résultats du traitement:</h3>';
    
    results.forEach((result, index) => {
        html += `
            <div style="margin-bottom: 1rem; padding: 1rem; background: ${result.success ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                <strong>Étape ${index + 1}:</strong> ${result.success ? '✅ Succès' : '❌ Erreur'}
                <details style="margin-top: 0.5rem;">
                    <summary>Détails</summary>
                    <pre style="margin-top: 0.5rem; font-size: 0.9rem;">${result.stdout || result.stderr || result.error}</pre>
                </details>
            </div>
        `;
    });
    
    resultsContent.innerHTML = html;
    resultsArea.style.display = 'block';
}

function viewResults() {
    window.open(`/results/${projectId}`, '_blank');
}

function exportResults() {
    alert('Fonctionnalité d\'export à implémenter');
}
</script>
{% endblock %}
